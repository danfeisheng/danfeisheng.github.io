---
layout: post
title: "读《高可用可伸缩微服务架构》感"
date: "2019-07-31 22:08"
author: "Danfei"
---
2019-07-31 22:08

读《高可用可伸缩微服务架构》感

第六章 微服务下如何保证事务的一致性

事务有四个基本特性，原子性，一致性，隔离性和持久性。其中原子性是指事务内的操作要么全部成功，要么全部失败，不会在中间某个环节结束。一致性指数据库在一个
事务执行之前和执行之后，都必须处于一致性状态。如果事务执行失败，那么需要自动回滚到原始的状态。换句话说，事务一旦提交，其他事务查看到的结果一致，事务
一旦回滚，其他事务也只能看到回滚前的状态。隔离性是指在并发环境中，不同的事务同时修改相同的数据，一个未完成事务不会影响另外一个未完成事务。持久性指事务
一旦提交，其修改的数据将永久保存在数据库中，改变是永久的。

本地事务通过ACID保证事务的强一致性。ACID是Atomic（原子性），Consistency（一致性），Isolation（隔离性）和Durability（持久性）的缩写。

面对海量数据，查询一次所花费的时间会变长，甚至会造成数据库的单点压力。因此，就要考虑分库分表方案了。分库和分表的目的在于，减小数据库的单库单表负担，
提高查询性能，缩短查询时间。我们先来看下单库拆分的场景，事实上，分表策略可以归纳为垂直拆分和水平拆分。垂直拆分是把表的字段进行拆分，即一张字段比较多的表
拆分为多张表，这样使得行数据变小。一方面可以减少客户端程序和数据库之间的网络传输的字节数，因为网络带宽有限，随着并发查询的增多，有可能造成带宽瓶颈从而
造成阻塞。另一方面，一个数据库能存放更多的数据，在查询时就会减少I/O的次数。水平拆分是把表的行进行拆分，因为表的行数超过几百万行时，就会变慢。这时可以把
一张表的数据拆分为多张表来存放。水平拆分有许多策略，例如取模分表，时间维度分表等。这种场景下，虽然我们根据特性规则分表了，仍然可以使用本地事务。但是，
库内分表仅解决了单表数据过大的问题，并没有把单表的数据分散到不同的物理机上，因此并不能减轻数据库服务器的压力，仍然存在同一个物理机上的资源竞争和瓶颈，
包括CPU，内存，磁盘I/O，网络带宽等。对于分库拆分的场景，把一张表的数据划分到不同的数据库中，多个数据库的表结构一样。此时，如果我们根据一定规则将需要使用
事务的数据路由到相同的库中，则可以通过本地事务保证其强一致性。但是对于按照业务和功能划分的垂直拆分，它将把业务数据分别放到不同的数据库中。拆分后系统就会
遇到数据的一致性问题，因为我们需要通过事务保证数据分散在不同的数据库中，而每个数据库只能保证自己的数据可以满足ACID的强一致性，但是在分布式系统中，他们
可能会部署在不同的服务器上，只能通过网络进行通信，因此无法准确地直到其他数据库中事务的执行情况。

此外，不仅在跨库调用时存在着本地事务无法解决的问题，随着微服务的落地，每个服务都有自己的数据库，并且数据库是相对独立切透明的。如果服务A需要获取服务B的
数据，就存在跨服务调用，如果遇到服务宕机，或者网络连接超时，同步调用超时等场景也会导致数据的不一致，这也是分布式场景下需要考虑的数据一致性问题。

业务量级扩大之后的分库，以及微服务落地之后的业务服务化，都会产生分布式数据的不一致问题。既然本地事务无法满足要求，就需要使用分布式事务。分布式事务可以
简单的理解，它是为了保证不同数据库的数据的一致性的事务解决方案。

CAP原则是Consistency（一致性），Availability（可用性）和Partition-tolerance（分区容错性）的缩写，它是分布式系统中的平衡理论。在分布式系统中，一致性
要求所有节点每次读操作都能保证获取最新的数据；可用性要求无论任何故障产生后都能保证服务仍然可用；分区容错性要求被分区的节点可以正常对外提供服务。事实上，
任务系统只能同时满足两个，对于分布式系统而言，分区容错性是一个最基本的要求，那么，如果选择了一致性和分区容错性，放弃可用性，那么网络问题会导致系统
不可用。如果选择可用性和分区容错性，放弃一致性，不同节点之间的数据不能及时同步数据，而导致数据的不一致。

此时，BASE理论针对一致性和可用性提出了一个方案，BASE是Basically Available（基本可用），Soft-sate（软状态）和Eventually Consistent（最终一致性）的缩写。
他是最终一致性的理论支撑。简单的理解，在分布式系统中，允许损失部分可用性，并且不同节点进行数据同步的过程存在延时，但是经过一段时间的修复后，能够达到
最终一致性。BASE理论强调的是数据的最终一致性。相比于ACID而言，BASE通过允许损失部分一致性来获得可用性。


