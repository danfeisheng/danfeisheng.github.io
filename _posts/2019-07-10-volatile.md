---
layout: post
title: "Volatile"
date: "2019-07-10 23:33"
author: "Danfei"
---
2019-07-10 23:33

Volatile

Volatile 解决了可见性和禁止指令重排序，但是没有同步语义，所以对于非原子操作，比如++，在多核处理器中仍旧会出现线程安全问题

假设变量i的值在主存中为1，这时有两个线程，线程a和线程b分别运行在处理器1和处理器2中，线程a读取i的值1后执行+1操作，但是并没有赋值到处理器1的工作内存中的i，
然后挂起，此时线程2开始执行，线程2执行+1操作，并且赋值给处理器2的工作内存中的i，刷新主存中的值为2，此时线程1开始执行，
**刷新处理器1的工作内存中的i的值为2，但是因为此前处理器中的+1操作已经执行完毕了，只剩下将此前算出来的2赋值回处理器1的工作内存了，所以这里即便刷新了处理器1中的工作内存的i的值，但是它不会被再次读取了）。
而是将之前计算出的2写回处理器1的，工作内存中的i，然后写回主存，主存中的值仍旧是2，也就是说线程2的操作被覆盖了。

++操作分3步，这3步并非原子操作：

	+ 读取变量的值
	+ 使变量的值+1
	+ 将+1后的值写回变量
